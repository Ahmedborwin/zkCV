import{aP as u,aQ as M,e as N,aR as h,aS as D,aT as c,aq as d,aU as O,aV as F,aW as R}from"./index.c4c19996.js";var l=Object.defineProperty,G=Object.defineProperties,X=Object.getOwnPropertyDescriptor,Y=Object.getOwnPropertyDescriptors,H=Object.getOwnPropertyNames,k=Object.getOwnPropertySymbols,L=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable,A=(e,t,n)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,q=(e,t)=>{for(var n in t||(t={}))L.call(t,n)&&A(e,n,t[n]);if(k)for(var n of k(t))Z.call(t,n)&&A(e,n,t[n]);return e},ee=(e,t)=>G(e,Y(t)),te=(e,t)=>function(){return e&&(t=(0,e[H(e)[0]])(e=0)),t},ne=(e,t)=>{for(var n in t)l(e,n,{get:t[n],enumerable:!0})},ie=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of H(t))!L.call(e,a)&&a!==n&&l(e,a,{get:()=>t[a],enumerable:!(r=X(t,a))||r.enumerable});return e},re=e=>ie(l({},"__esModule",{value:!0}),e),s=(e,t,n)=>new Promise((r,a)=>{var S=o=>{try{p(n.next(o))}catch(m){a(m)}},Q=o=>{try{p(n.throw(o))}catch(m){a(m)}},p=o=>o.done?r(o.value):Promise.resolve(o.value).then(S,Q);p((n=n.apply(e,t)).next())}),U={};ne(U,{default:()=>B,dependencies:()=>I,devDependencies:()=>T,files:()=>v,gitHead:()=>E,license:()=>b,main:()=>y,module:()=>P,name:()=>f,peerDependencies:()=>j,publishConfig:()=>C,scripts:()=>x,type:()=>_,types:()=>w,version:()=>g});var f,g,v,_,y,P,w,b,C,j,I,T,x,E,B,se=te({"package.json"(){f="@particle-network/provider",g="1.3.2",v=["es","lib","LICENSE"],_="module",y="lib/index.js",P="es/index.js",w="lib/types/index.d.ts",b="Apache-2.0",C={access:"public"},j={"@particle-network/auth":"*"},I={"@particle-network/chains":"*",axios:"^1.3.6",uuid:"^8.3.2"},T={"@particle-network/auth":"^1.3.1","@types/uuid":"^8.3.4","ts-loader":"^9.3.1","webpack-cli":"^4.10.0"},x={package:`shx echo '{ "type": "commonjs" }' > lib/package.json`,build:"yarn clean && node ./esBuild.js && tsc --emitDeclarationOnly -p tsconfig.json && yarn package",clean:"shx rm -rf lib/* && shx rm -rf es/*","build:min.js":"webpack",version:"yarn build"},E="cc999e430ebfb1dd821783f7cf099ddd51f3495a",B={name:f,version:g,files:v,type:_,main:y,module:P,types:w,license:b,publishConfig:C,peerDependencies:j,dependencies:I,devDependencies:T,scripts:x,gitHead:E}}}),i=class extends Error{constructor(e,t,n){super(t),this.code=e,this.message=t,this.data=n,this.code=e,this.message=t,this.data=n}static userRejectedRequest(){return new i(4001,"The user rejected the request")}static userCancelOperation(){return new i(4011,"The user cancel the operation")}static unauthorized(){return new i(4100,"The requested method and/or account has not been authorized by the user")}static unsupportedMethod(){return new i(4200,"The Provider does not support the requested method")}static unsupportedChain(){return new i(4201,"The Provider does not support the chain")}static disconnected(){return new i(4900,"The Provider is disconnected from all chains")}static chainDisconnected(){return new i(4901,"The Provider is not connected to the requested chain")}static paramsError(){return new i(8002,"Param error, see doc for more info")}},W=class{},ae=class extends W{constructor(){super(...arguments),this.events=new N.exports.EventEmitter}on(e,t){return this.events.on(e,t),this}once(e,t){return this.events.once(e,t),this}off(e,t){return this.events.off(e,t),this}removeListener(e,t){return this.events.removeListener(e,t),this}},V=class extends W{constructor(){super(...arguments),this.events=new N.exports.EventEmitter}on(e,t){return this.events.on(e,t),this}once(e,t){return this.events.once(e,t),this}off(e,t){return this.events.off(e,t),this}removeListener(e,t){return this.events.removeListener(e,t),this}},$=["eth_signTransaction","eth_sign","eth_sendRawTransaction"],J=["eth_requestAccounts","eth_accounts","eth_chainId","eth_sendTransaction","eth_signTypedData","eth_signTypedData_v1","eth_signTypedData_v3","eth_signTypedData_v4","personal_sign","wallet_switchEthereumChain","wallet_addEthereumChain","wallet_watchAsset"],z=["personal_sign_uniq","eth_signTypedData_v4_uniq"],oe=class{constructor(e){this.auth=e,this.auth=e}request(e){return s(this,null,function*(){if(e.method==="eth_requestAccounts"||e.method==="eth_accounts"){let t=this.auth.getWallet();if(t)return[t.public_address];if(yield this.auth.login(),t=this.auth.getWallet(),t)return[t.public_address];throw new Error("Create wallet failed")}else{if(e.method==="eth_chainId")return u(this.auth.getChainId());if(e.method==="eth_sendTransaction")if(e.params&&e.params instanceof Array&&e.params[0]){const t=e.params[0];return h(t.type)&&(D.isChainSupportEIP1559(this.auth.getChain())?t.type="0x2":t.type="0x0"),h(t.chainId)&&(t.chainId=u(this.auth.getChainId())),h(t.nonce)&&(t.nonce="0x0"),h(t.data)&&(t.data="0x"),this.auth.sendTransaction(this.legacyToString(e.params[0]))}else return Promise.reject(i.paramsError());else if(e.method==="eth_signTypedData_v3"||e.method==="eth_signTypedData_v4"||e.method==="eth_signTypedData_v4_uniq")if(e.params&&e.params instanceof Array&&e.params.length>=2){let t=e.params[1];return typeof t=="string"&&!t.startsWith("0x")&&(t=c(d.Buffer.from(t).toString("hex"))),this.auth.sign(e.method,this.legacyToString(t))}else return Promise.reject(i.paramsError());else if(e.method==="eth_signTypedData"||e.method==="eth_signTypedData_v1")if(e.params&&e.params instanceof Array&&e.params[0]){let t=e.params[0];return typeof t=="string"&&!t.startsWith("0x")&&(t=c(d.Buffer.from(t).toString("hex"))),this.auth.sign(e.method,this.legacyToString(t))}else return Promise.reject(i.paramsError());else{if(e.method==="personal_sign"||e.method==="personal_sign_uniq")return e.params&&e.params instanceof Array&&e.params[0]?this.auth.sign(e.method,this.legacyToString(e.params[0])):Promise.reject(i.paramsError());if(e.method==="wallet_switchEthereumChain")if(e.params&&e.params instanceof Array&&e.params[0]&&e.params[0].chainId){const t=Number(e.params[0].chainId),n=D.getEVMChainInfoById(t);return n?(yield this.auth.switchChain(n),Promise.resolve(null)):Promise.reject(i.unsupportedChain())}else return Promise.reject(i.paramsError());else return Promise.reject(i.unsupportedMethod())}}})}legacyToString(e){let t;return typeof e=="number"?t=c(e.toString(16)):typeof e=="string"?e.toString().startsWith("0x")?t=e:t=c(d.Buffer.from(e).toString("hex")):t=c(d.Buffer.from(JSON.stringify(e)).toString("hex")),t}},K=class extends ae{constructor(e){if(super(),this.config=e,this.registering=!1,!O(e.url))throw new Error(`Provided URL is not compatible with HTTP connection: ${e.url}`);this.config=e}get connected(){return typeof this.api<"u"}get connecting(){return this.registering}open(){return s(this,null,function*(){this.api=yield this.register()})}close(){return s(this,null,function*(){this.onClose()})}send(e){return s(this,null,function*(){return typeof this.api>"u"&&(this.api=yield this.register()),this.api.post("/",e).then(t=>t.data)})}register(){return s(this,null,function*(){const e=this.config;if(!O(e.url))throw new Error(`Provided URL is not compatible with HTTP connection: ${e.url}`);if(this.registering)return new Promise((n,r)=>{this.events.once("open",()=>{if(typeof this.api>"u")return r(new Error("HTTP connection is missing or invalid"));n(this.api)})});this.registering=!0;const t=F.create({baseURL:e.url,timeout:3e4,headers:{Accept:"application/json","Content-Type":"application/json"}});return t.interceptors.request.use(function(n){var r,a;return n.params||(n.params={}),n.params.chainId=(a=(r=n.data)==null?void 0:r.chainId)!=null?a:e.chainId(),n.params.projectUuid=e.authentication.projectId,n.params.projectKey=e.authentication.clientKey,n},n=>Promise.reject(n)),this.onOpen(t),t})}onOpen(e){this.api=e,this.registering=!1,this.events.emit("open")}onClose(){this.api=void 0,this.events.emit("close")}};function ce(){return`web_${(se(),re(U)).version}`}var de=class extends V{constructor(e){super(),this.auth=e,this.isParticleNetwork=!0,this.auth=e,this.connection=this.setConnection(),this.authAdapter=new oe(this.auth),this.auth.on("chainChanged",t=>{t.name!=="Solana"&&this.emit("chainChanged",u(t.id))}),typeof window<"u"&&window.particle&&(window.particle.particleProvider=this)}get version(){return ce()}setConnection(){return new K({url:`${M()}/evm-chain`,basicCredentials:this.auth.basicCredentials(),chainId:()=>this.auth.getChainId(),authentication:this.auth.config})}emit(e,...t){return this.events.emit(e,...t)}disconnect(){return s(this,null,function*(){return this.auth.logout()})}enable(){return s(this,null,function*(){return this.request({method:"eth_requestAccounts"})})}request(e){return s(this,null,function*(){var t,n;if(!e.method||$.includes(e.method))return Promise.reject(i.unsupportedMethod());this.connection.connected||(yield this.open());const r={chainId:Number(this.auth.getChainId()),id:(t=e.id)!=null?t:R(),jsonrpc:(n=e.jsonrpc)!=null?n:"2.0",method:e.method,params:e.params};return J.includes(e.method)||z.includes(e.method)?this.authAdapter.request(e):this.requestStrict(r)})}requestStrict(e){return s(this,null,function*(){return this.connection.send(e).then(t=>t.error?Promise.reject(t.error):Promise.resolve(t.result))})}open(){return s(this,null,function*(){yield this.connection.open(),this.connection.on("close",()=>this.emit("disconnect")),this.emit("connect",{chainId:u(this.auth.getChainId())})})}close(){return s(this,null,function*(){yield this.connection.close()})}},ue=class extends V{constructor(e,t){super(),this.auth=e,this.signerProvider=t,this.isParticleDelegateProvider=!0,this.connection=this.setConnection(),this.listenEvent()}listenEvent(){const e=this.events;this.signerProvider.on("connect",t=>e.emit("connect",t)),this.signerProvider.on("disconnect",t=>e.emit("disconnect",t)),this.signerProvider.on("message",t=>e.emit("message",t)),this.signerProvider.on("chainChanged",t=>e.emit("chainChanged",t)),this.signerProvider.on("accountsChanged",t=>e.emit("accountsChanged",t))}setConnection(){return new K({url:`${M()}/evm-chain`,basicCredentials:this.auth.basicCredentials(),chainId:()=>{var e;return(e=this.chainId)!=null?e:this.auth.getChainId()},authentication:this.auth.config})}disconnect(){return s(this,null,function*(){const e=this.signerProvider;if(e.disconnect&&typeof e.disconnect=="function")try{yield e.disconnect()}catch{}})}enable(){return s(this,null,function*(){const e=this.signerProvider;let t;if(e.enable&&typeof e.enable=="function")try{t=yield e.enable()}catch{t=yield this.request({method:"eth_requestAccounts"})}return t})}request(e){return s(this,null,function*(){var t,n;if(!e.method||$.includes(e.method))return Promise.reject(i.unsupportedMethod());this.connection.connected||(yield this.open());const r={id:(t=e.id)!=null?t:R(),jsonrpc:(n=e.jsonrpc)!=null?n:"2.0",method:e.method,params:e.params};if(J.includes(r.method)||this.isParticleSignerMethod(r.method))return yield this.signerProvider.request(r);{try{this.chainId=Number(yield this.signerProvider.request({method:"eth_chainId"}))}catch{this.chainId=Number(this.auth.getChainId())}const a=ee(q({},r),{chainId:this.chainId});return yield this.requestStrict(a)}})}isParticleSignerMethod(e){return this.signerProvider.isParticleNetwork&&z.includes(e)}requestStrict(e){return s(this,null,function*(){return this.connection.send(e).then(t=>t.error?Promise.reject(t.error):Promise.resolve(t.result))})}open(){return s(this,null,function*(){yield this.connection.open()})}};export{ue as ParticleDelegateProvider,de as ParticleProvider};
